<!DOCTYPE html>
<html lang="ko">
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Classroom Auto-Grader</title>
    <style>
      :root {
        --primary-color: #4285f4;
        --danger-color: #ea4335;
        --success-color: #34a853;
        --warning-color: #fbbc05;
        --light-gray: #f9f9f9;
        --border-color: #ddd;
      }
      
      body {
        font-family: 'Roboto', Arial, sans-serif;
        padding: 20px;
        margin: 0;
        background-color: #f5f5f5;
        color: #333;
        line-height: 1.6;
      }
      
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      
      h2 {
        color: var(--primary-color);
        text-align: center;
        margin-bottom: 20px;
      }
      
      .step {
        background: white;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        border-left: 4px solid var(--primary-color);
      }
      
      .step-header {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
      }
      
      .step-number {
        display: inline-block;
        width: 30px;
        height: 30px;
        background-color: var(--primary-color);
        color: white;
        border-radius: 50%;
        text-align: center;
        line-height: 30px;
        margin-right: 10px;
        font-weight: bold;
      }
      
      .step-title {
        font-weight: bold;
        font-size: 16px;
      }
      
      label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
      }
      
      select, button {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        border: 1px solid var(--border-color);
        font-size: 14px;
      }
      
      select[multiple] {
        height: 200px;
      }
      
      button {
        background-color: var(--primary-color);
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
        margin-top: 15px;
      }
      
      button:hover {
        background-color: #3367d6;
      }
      
      button:disabled {
        background-color: #a8c7fa;
        cursor: not-allowed;
      }
      
      button.danger {
        background-color: var(--danger-color);
      }
      
      button.danger:hover {
        background-color: #c5221f;
      }
      
      #log {
        border: 1px solid var(--border-color);
        padding: 10px;
        background: var(--light-gray);
        height: 250px;
        overflow-y: scroll;
        font-family: monospace;
        white-space: pre-wrap;
        border-radius: 4px;
        font-size: 13px;
      }
      
      .status-banner {
        padding: 10px 15px;
        border-radius: 4px;
        margin-bottom: 15px;
        display: none;
      }
      
      .status-banner.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      
      .status-banner.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      
      .status-banner.warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeeba;
      }
      
      .progress-container {
        width: 100%;
        height: 20px;
        background-color: #eee;
        border-radius: 10px;
        margin: 15px 0;
        overflow: hidden;
        display: none;
      }
      
      .progress-bar {
        height: 100%;
        width: 0%;
        background-color: var(--primary-color);
        transition: width 0.3s;
      }
      
      /* Responsive adjustments */
      @media (max-width: 768px) {
        .container {
          padding: 15px;
        }
        
        .step {
          padding: 10px;
        }
        
        select[multiple] {
          height: 150px;
        }
      }
      
      .loading-spinner {
        display: inline-block;
        width: 15px;
        height: 15px;
        border: 3px solid rgba(255,255,255,.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
        vertical-align: middle;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: bold;
        margin-left: 5px;
      }
      
      .badge-turned-in {
        background-color: var(--success-color);
        color: white;
      }
      
      .badge-created {
        background-color: var(--warning-color);
        color: white;
      }
      
      .badge-returned {
        background-color: var(--primary-color);
        color: white;
      }
      
      .badge-count {
        background-color: var(--light-gray);
        color: #333;
      }
      
      .student-item {
        padding: 8px;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
      }
      
      .student-item:hover {
        background-color: #f5f5f5;
      }
      
      .student-checkbox {
        margin-right: 10px;
      }
      
      textarea {
        width: 100%;
        resize: vertical;
        font-family: monospace;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
      }
      
      .hint-text {
        font-size: 12px;
        color: #666;
        margin-top: 5px;
      }
      
      .toggle-button {
        margin-bottom: 15px;
        background-color: #f5f5f5;
        border: 1px solid var(--border-color);
        color: #333;
      }
      
      .toggle-button:hover {
        background-color: #e8e8e8;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>ğŸ“š Google Classroom ê³¼ì œ ì±„ì ê¸°</h2>
      
      <div id="statusBanner" class="status-banner"></div>
      
      <div class="step">
        <div class="step-header">
          <div class="step-number">1</div>
          <div class="step-title">ê³¼ëª© ì„ íƒ</div>
        </div>
        <select id="courseSelect" aria-label="ê³¼ëª© ì„ íƒ" onchange="loadCourseWork()"></select>
      </div>
      
      <div class="step">
        <div class="step-header">
          <div class="step-number">2</div>
          <div class="step-title">ê³¼ì œ ì„ íƒ</div>
        </div>
        <select id="courseWorkSelect" aria-label="ê³¼ì œ ì„ íƒ" onchange="loadStudents()">
          <option value="">ê³¼ëª©ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”</option>
        </select>
      </div>
      
      <div class="step">
        <div class="step-header">
          <div class="step-number">3</div>
          <div class="step-title">í•™ìƒ ì„ íƒ (ìµœëŒ€ 30ëª…)</div>
        </div>
        <div id="studentCountInfo">í•™ìƒ ëª©ë¡ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</div>
        
        <div id="studentList" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; margin-bottom: 10px;">
          <!-- í•™ìƒ ëª©ë¡ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
        
        <div>
          <button id="selectAllBtn" onclick="selectAllStudents()">ëª¨ë‘ ì„ íƒ</button>
          <button id="deselectAllBtn" onclick="deselectAllStudents()">ëª¨ë‘ ì„ íƒ í•´ì œ</button>
        </div>
      </div>
      
      <div class="step">
        <div class="step-header">
          <div class="step-number">4</div>
          <div class="step-title">ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì„¤ì •</div>
        </div>
        <button id="showPromptSettingsBtn" class="toggle-button" onclick="togglePromptSettings()">ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì„¤ì • ë³´ê¸°/ìˆ¨ê¸°ê¸°</button>
        
        <div id="promptSettingsContainer" style="display: none; margin-top: 15px;">
          <label for="systemPrompt">Gemini API ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸:</label>
          <textarea id="systemPrompt" style="width: 100%; height: 300px; font-family: monospace; margin-bottom: 10px;"></textarea>
          <div style="display: flex; gap: 10px;">
            <button onclick="savePrompt()">í”„ë¡¬í”„íŠ¸ ì €ì¥</button>
            <button onclick="resetPromptToDefault()" class="danger">ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”</button>
          </div>
          <div style="margin-top: 10px; font-size: 12px; color: #666;">
            <p>í”„ë¡¬í”„íŠ¸ì— ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ë³€ìˆ˜:</p>
            <ul>
              <li><code>{questionText}</code> - ë¬¸ì œ ë‚´ìš©</li>
              <li><code>{rubricText}</code> - ì±„ì  ê¸°ì¤€</li>
              <li><code>{studentAnswer}</code> - í•™ìƒ ë‹µì•ˆ</li>
            </ul>
            <p>ì´ ë³€ìˆ˜ë“¤ì€ ì‹¤ì œ ì±„ì  ì‹œ í•´ë‹¹ ë‚´ìš©ìœ¼ë¡œ ìë™ ëŒ€ì²´ë©ë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>
      
      <div id="progressContainer" class="progress-container">
        <div id="progressBar" class="progress-bar"></div>
      </div>
      
      <button id="gradeBtn" onclick="gradeSelectedStudents()">
        <span id="gradeBtnText">âœ… ì„ íƒí•œ í•™ìƒ ì±„ì í•˜ê¸°</span>
      </button>
      
      <button id="resetAuthButton" onclick="resetAuth()" class="danger">
        ğŸ”„ ì¸ì¦ ì •ë³´ ì´ˆê¸°í™”
      </button>
      
      <div class="step">
        <div class="step-header">
          <div class="step-number">5</div>
          <div class="step-title">ì²˜ë¦¬ ë¡œê·¸</div>
        </div>
        <div id="log"></div>
      </div>
    </div>

    <script>
      // ì „ì—­ ë³€ìˆ˜
      let isProcessing = false;
      let studentData = [];
      let processedCount = 0;
      let totalSelected = 0;
      
      // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
      function showStatus(message, type = 'success') {
        const banner = document.getElementById('statusBanner');
        banner.textContent = message;
        banner.className = 'status-banner ' + type;
        banner.style.display = 'block';
        
        // ì„±ê³µ ë©”ì‹œì§€ëŠ” 5ì´ˆ í›„ ìë™ìœ¼ë¡œ ìˆ¨ê¹€
        if (type === 'success') {
          setTimeout(() => {
            banner.style.display = 'none';
          }, 5000);
        }
      }
      
      // ë¡œê·¸ í•¨ìˆ˜
      function log(msg) {
        const logDiv = document.getElementById('log');
        const now = new Date();
        const timestamp = now.toLocaleTimeString();
        logDiv.textContent += `[${timestamp}] ${msg}\n`;
        logDiv.scrollTop = logDiv.scrollHeight;
      }
      
      // ê³¼ì œ ë¡œë“œ í•¨ìˆ˜
      function loadCourseWork() {
        const courseId = document.getElementById('courseSelect').value;
        if (!courseId) return;
        
        const courseWorkSelect = document.getElementById('courseWorkSelect');
        courseWorkSelect.innerHTML = '<option value="">ê³¼ì œ ë¡œë”© ì¤‘...</option>';
        document.getElementById('studentList').innerHTML = '';
        updateButtonStates();
        
        log(`ğŸ“¥ ê³¼ëª© ID: ${courseId}ì˜ ê³¼ì œ ë¡œë”© ì¤‘...`);
        
        google.script.run
          .withSuccessHandler(courseWorkHandler)
          .withFailureHandler(errorHandler)
          .getCourseWork(courseId);
      }
      
      // ê³¼ì œ ì‘ë‹µ ì²˜ë¦¬ í•¨ìˆ˜
      function courseWorkHandler(cwList) {
        const select = document.getElementById('courseWorkSelect');
        select.innerHTML = '';
        
        if (!cwList || cwList.length === 0) {
          select.innerHTML = '<option value="">ê³¼ì œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ</option>';
          log('âš ï¸ ì´ ê³¼ëª©ì— ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤');
          return;
        }
        
        cwList.forEach(cw => {
          const option = document.createElement('option');
          option.value = cw.id;
          option.textContent = cw.title;
          
          // ìƒíƒœ ë±ƒì§€ ì¶”ê°€
          const badge = document.createElement('span');
          badge.className = `badge badge-${cw.state.toLowerCase()}`;
          badge.textContent = cw.state;
          option.appendChild(badge);
          
          select.appendChild(option);
        });
        
        log(`âœ… ${cwList.length}ê°œ ê³¼ì œ ë¡œë“œ ì™„ë£Œ`);
        loadStudents();
      }
      
      // í•™ìƒ ë¡œë“œ í•¨ìˆ˜
      function loadStudents() {
        const courseId = document.getElementById('courseSelect').value;
        const courseWorkId = document.getElementById('courseWorkSelect').value;
        
        if (!courseId || !courseWorkId) {
          document.getElementById('studentList').innerHTML = '';
          document.getElementById('studentCountInfo').textContent = 'ê³¼ëª©ê³¼ ê³¼ì œë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”';
          updateButtonStates();
          return;
        }
        
        const studentList = document.getElementById('studentList');
        studentList.innerHTML = '<div class="student-item">í•™ìƒ ë¡œë”© ì¤‘...</div>';
        document.getElementById('studentCountInfo').textContent = 'í•™ìƒ ë¡œë”© ì¤‘...';
        updateButtonStates();
        
        log(`ğŸ“¥ í•™ìƒ ì œì¶œë¬¼ ë¡œë”© ì¤‘...`);
        
        google.script.run
          .withSuccessHandler(studentHandler)
          .withFailureHandler(errorHandler)
          .getStudentSubmissionList(courseId, courseWorkId);
      }
      
      // í•™ìƒ ì‘ë‹µ ì²˜ë¦¬ í•¨ìˆ˜
      function studentHandler(data) {
        const studentList = document.getElementById('studentList');
        studentList.innerHTML = '';
        studentData = data || [];
        
        if (studentData.length === 0) {
          studentList.innerHTML = '<div class="student-item">í•™ìƒ ì œì¶œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
          document.getElementById('studentCountInfo').textContent = 'í•™ìƒ ì œì¶œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
          log('âš ï¸ í•™ìƒ ì œì¶œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
          updateButtonStates();
          return;
        }
        
        // ìƒíƒœë³„ ì œì¶œë¬¼ ê°œìˆ˜ ê³„ì‚°
        const stateCounts = studentData.reduce((acc, item) => {
          acc[item.state] = (acc[item.state] || 0) + 1;
          return acc;
        }, {});
        
        // ê°œìˆ˜ ì •ë³´ í‘œì‹œ
        const countInfo = document.getElementById('studentCountInfo');
        countInfo.innerHTML = `${studentData.length}ê°œ ì œì¶œë¬¼ ë°œê²¬ `;
        
        // ê° ìƒíƒœë³„ ë±ƒì§€ ì¶”ê°€
        Object.entries(stateCounts).forEach(([state, count]) => {
          const badge = document.createElement('span');
          badge.className = 'badge badge-count';
          badge.textContent = `${state}: ${count}`;
          countInfo.appendChild(badge);
        });
        
        // ìµœëŒ€ 30ê°œ í•™ìƒë§Œ í‘œì‹œ
        const displayedCount = Math.min(studentData.length, 30);
        studentData.slice(0, 30).forEach((item, index) => {
          const studentItem = document.createElement('div');
          studentItem.className = 'student-item';
          
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'student-checkbox';
          checkbox.id = `student-${index}`;
          checkbox.value = index;
          checkbox.addEventListener('change', updateButtonStates);
          
          const label = document.createElement('label');
          label.htmlFor = `student-${index}`;
          
          // ìƒíƒœì— ë”°ë¥¸ ì´ëª¨ì§€ ì¶”ê°€
          const statusEmoji = item.state === 'TURNED_IN' ? 'ğŸ“' : 
                           item.state === 'RETURNED' ? 'âœ…' : 'â³';
                           
          label.textContent = `${statusEmoji} ${item.name} `;
          
          // ìƒíƒœ ë±ƒì§€ ì¶”ê°€
          const badge = document.createElement('span');
          badge.className = `badge badge-${item.state.toLowerCase()}`;
          badge.textContent = item.state;
          label.appendChild(badge);
          
          studentItem.appendChild(checkbox);
          studentItem.appendChild(label);
          studentList.appendChild(studentItem);
        });
        
        // 30ê°œ ì´ìƒì¸ ê²½ìš° ê²½ê³  í‘œì‹œ
        if (studentData.length > 30) {
          log(`âš ï¸ ${studentData.length}ê°œ ì œì¶œë¬¼ ì¤‘ ì²˜ë¦¬ ì œí•œìœ¼ë¡œ ì²˜ìŒ 30ê°œë§Œ í‘œì‹œí•©ë‹ˆë‹¤`);
          showStatus(`ì²˜ë¦¬ ì œí•œìœ¼ë¡œ ${studentData.length}ê°œ ì¤‘ ì²˜ìŒ 30ê°œë§Œ í‘œì‹œí•©ë‹ˆë‹¤`, 'warning');
        } else {
          log(`âœ… ${studentData.length}ê°œ í•™ìƒ ì œì¶œë¬¼ ë¡œë“œ ì™„ë£Œ`);
        }
        
        updateButtonStates();
      }
      
      // ì˜¤ë¥˜ ì²˜ë¦¬ í•¨ìˆ˜
      function errorHandler(error) {
        log(`âŒ ì˜¤ë¥˜: ${error.message || error}`);
        showStatus(`ì˜¤ë¥˜: ${error.message || error}`, 'error');
      }
      
      // ëª¨ë“  í•™ìƒ ì„ íƒ í•¨ìˆ˜
      function selectAllStudents() {
        const checkboxes = document.querySelectorAll('.student-checkbox');
        checkboxes.forEach(cb => {
          cb.checked = true;
        });
        updateButtonStates();
      }
      
      // ëª¨ë“  í•™ìƒ ì„ íƒ í•´ì œ í•¨ìˆ˜
      function deselectAllStudents() {
        const checkboxes = document.querySelectorAll('.student-checkbox');
        checkboxes.forEach(cb => {
          cb.checked = false;
        });
        updateButtonStates();
      }
      
      // ì„ íƒëœ í•™ìƒ ì±„ì  í•¨ìˆ˜
      function gradeSelectedStudents() {
        // ì²´í¬ëœ ëª¨ë“  ì²´í¬ë°•ìŠ¤ ìˆ˜ì§‘
        const checkboxes = document.querySelectorAll('.student-checkbox:checked');
        if (checkboxes.length === 0) {
          showStatus('ìµœì†Œí•œ í•œ ëª…ì˜ í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”', 'warning');
          return;
        }
        
        // ì„ íƒëœ í•™ìƒ ì¸ë±ìŠ¤ ë°°ì—´ ìƒì„±
        const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.value));
        
        // ì„ íƒëœ í•™ìƒ ë°ì´í„° ìˆ˜ì§‘
        const selectedStudents = selectedIndices.map(idx => studentData[idx]);
        totalSelected = selectedStudents.length;
        
        // ì±„ì  í™•ì¸
        if (!confirm(`${totalSelected}ëª…ì˜ í•™ìƒ ì œì¶œë¬¼ì„ ì±„ì í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          return;
        }
        
        // ì²˜ë¦¬ ìƒíƒœë¡œ UI ì—…ë°ì´íŠ¸
        isProcessing = true;
        processedCount = 0;
        document.getElementById('gradeBtn').disabled = true;
        document.getElementById('gradeBtnText').innerHTML = '<span class="loading-spinner"></span> ì±„ì  ì§„í–‰ ì¤‘...';
        document.getElementById('progressContainer').style.display = 'block';
        document.getElementById('progressBar').style.width = '0%';
        updateButtonStates();
        
        log(`ğŸš€ ${totalSelected}ëª…ì˜ ì œì¶œë¬¼ ì±„ì  ì‹œì‘`);
        showStatus(`${totalSelected}ëª…ì˜ ì œì¶œë¬¼ ì±„ì  ì¤‘...`, 'warning');
        
        // ê³¼ëª© ë° ê³¼ì œ ID ê°€ì ¸ì˜¤ê¸°
        const courseId = document.getElementById('courseSelect').value;
        const courseWorkId = document.getElementById('courseWorkSelect').value;
        
        // API ì œí•œì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì§€ì—°ì‹œê°„ì„ ë‘ê³  ê° í•™ìƒ ì±„ì 
        selectedStudents.forEach((student, index) => {
          setTimeout(() => {
            log(`â³ ì±„ì  ${index + 1}/${totalSelected}: ${student.name}`);
            
            google.script.run
              .withSuccessHandler(result => handleGradingResult(result, student))
              .withFailureHandler(error => handleGradingError(error, student))
              .autoGradeStudentEssay(
                student.name,
                student.docId,
                courseId,
                courseWorkId,
                student.submissionId
              );
          }, index * 5000); // í•™ìƒë‹¹ 5ì´ˆ ê°„ê²©ìœ¼ë¡œ ì²˜ë¦¬
        });
      }
      
      // ì±„ì  ê²°ê³¼ ì²˜ë¦¬ í•¨ìˆ˜
      function handleGradingResult(result, student) {
        processedCount++;
        updateProgress();
        
        if (result.score !== null) {
          let statusSymbol = 'â“';
          if (result.scoreAssigned) statusSymbol = 'âœ…';
          else if (result.score !== null) statusSymbol = 'ğŸ“Š';
          else statusSymbol = 'âŒ';
          
          const feedbackSymbol = result.feedbackAdded ? 'âœ…' : 'âŒ';
          
          log(`${statusSymbol} ${student.name} | ì ìˆ˜: ${result.score} | ` +
              `ì ìˆ˜ í• ë‹¹: ${result.scoreAssigned ? 'Yes' : 'No'} | ` +
              `í”¼ë“œë°±: ${feedbackSymbol} (${result.feedbackCount || 0} í•­ëª©)`);
          
          // ì˜¤ë¥˜ ë©”ì‹œì§€ê°€ ìˆëŠ” ê²½ìš°
          if (result.error) {
            log(`âš ï¸ ì˜¤ë¥˜ ìƒì„¸: ${result.error}`);
          }
        } else {
          log(`âš ï¸ ${student.name} | ì˜¤ë¥˜: ${result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
        }
        
        checkIfComplete();
      }
      
      // ì±„ì  ì˜¤ë¥˜ ì²˜ë¦¬ í•¨ìˆ˜
      function handleGradingError(error, student) {
        processedCount++;
        updateProgress();
        log(`âŒ ${student.name} ì±„ì  ì˜¤ë¥˜: ${error.message || error}`);
        checkIfComplete();
      }
      
      // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateProgress() {
        const percent = Math.round((processedCount / totalSelected) * 100);
        document.getElementById('progressBar').style.width = `${percent}%`;
      }
      
      // ëª¨ë“  ì²˜ë¦¬ ì™„ë£Œ í™•ì¸ í•¨ìˆ˜
      function checkIfComplete() {
        if (processedCount >= totalSelected) {
          log(`âœ… ì±„ì  ì™„ë£Œ: ${processedCount}/${totalSelected} ì œì¶œë¬¼ ì²˜ë¦¬ë¨`);
          showStatus(`ì±„ì  ì™„ë£Œ: ${processedCount}/${totalSelected} ì œì¶œë¬¼ ì²˜ë¦¬ë¨`, 'success');
          
          // UI ì´ˆê¸°í™”
          isProcessing = false;
          document.getElementById('gradeBtn').disabled = false;
          document.getElementById('gradeBtnText').textContent = 'âœ… ì„ íƒí•œ í•™ìƒ ì±„ì í•˜ê¸°';
          
          // 2ì´ˆ í›„ ì§„í–‰ ë§‰ëŒ€ ìˆ¨ê¸°ê¸°
          setTimeout(() => {
            document.getElementById('progressContainer').style.display = 'none';
          }, 2000);
          
          updateButtonStates();
        }
      }
      
      // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
      function updateButtonStates() {
        const courseId = document.getElementById('courseSelect').value;
        const courseWorkId = document.getElementById('courseWorkSelect').value;
        const checkedStudents = document.querySelectorAll('.student-checkbox:checked').length;
        
        // ì±„ì  ë²„íŠ¼
        document.getElementById('gradeBtn').disabled = 
          isProcessing || !courseId || !courseWorkId || checkedStudents === 0;
        
        // ì „ì²´ ì„ íƒ/í•´ì œ ë²„íŠ¼
        const studentCount = document.querySelectorAll('.student-checkbox').length;
        document.getElementById('selectAllBtn').disabled = 
          isProcessing || studentCount === 0;
        document.getElementById('deselectAllBtn').disabled = 
          isProcessing || studentCount === 0;
      }
      
      // ì¸ì¦ ì´ˆê¸°í™” í•¨ìˆ˜
      function resetAuth() {
        if (confirm("ì •ë§ ì¸ì¦ ì •ë³´ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nëª¨ë“  í† í°ì´ ì‚­ì œë˜ë©° ë‹¤ì‹œ ì¸ì¦í•´ì•¼ í•©ë‹ˆë‹¤.")) {
          log("ğŸ”„ ì¸ì¦ ì •ë³´ ì´ˆê¸°í™” ì¤‘...");
          
          google.script.run
            .withSuccessHandler(function() {
              log("âœ… ì¸ì¦ ì •ë³´ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. 3ì´ˆ í›„ í˜ì´ì§€ê°€ ìƒˆë¡œê³ ì¹¨ë©ë‹ˆë‹¤.");
              setTimeout(function() {
                window.top.location.reload();
              }, 3000);
            })
            .withFailureHandler(function(error) {
              log(`âŒ ì¸ì¦ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message || error}`);
              showStatus(`ì¸ì¦ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message || error}`, 'error');
            })
            .resetOAuthAuthorization();
        }
      }
      
      // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ê´€ë ¨ í•¨ìˆ˜ë“¤
      function togglePromptSettings() {
        const container = document.getElementById('promptSettingsContainer');
        if (container.style.display === 'none') {
          container.style.display = 'block';
          loadSystemPrompt();
        } else {
          container.style.display = 'none';
        }
      }

      // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë¡œë“œ
      function loadSystemPrompt() {
        log('ğŸ“„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì¤‘...');
        google.script.run
          .withSuccessHandler(prompt => {
            document.getElementById('systemPrompt').value = prompt;
            log('âœ… ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì™„ë£Œ');
          })
          .withFailureHandler(error => {
            log(`âŒ í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì˜¤ë¥˜: ${error.message || error}`);
            showStatus(`í”„ë¡¬í”„íŠ¸ ë¡œë“œ ì˜¤ë¥˜: ${error.message || error}`, 'error');
          })
          .getSystemPrompt();
      }

      // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì €ì¥
      function savePrompt() {
        const prompt = document.getElementById('systemPrompt').value;
        if (!prompt || prompt.trim() === '') {
          showStatus('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
          return;
        }

        log('ğŸ’¾ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì €ì¥ ì¤‘...');
        google.script.run
          .withSuccessHandler(result => {
            if (result) {
              log('âœ… ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
              showStatus('ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
            } else {
              log('âš ï¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì €ì¥ ì‹¤íŒ¨');
              showStatus('ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
          })
          .withFailureHandler(error => {
            log(`âŒ í”„ë¡¬í”„íŠ¸ ì €ì¥ ì˜¤ë¥˜: ${error.message || error}`);
            showStatus(`í”„ë¡¬í”„íŠ¸ ì €ì¥ ì˜¤ë¥˜: ${error.message || error}`, 'error');
          })
          .saveSystemPrompt(prompt);
      }

      // ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™”
      function resetPromptToDefault() {
        if (!confirm('ì •ë§ë¡œ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          return;
        }

        log('ğŸ”„ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™” ì¤‘...');
        google.script.run
          .withSuccessHandler(result => {
            if (result) {
              log('âœ… ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ê°€ ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤');
              showStatus('ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤', 'success');
              loadSystemPrompt(); // ì´ˆê¸°í™”ëœ í”„ë¡¬í”„íŠ¸ ë‹¤ì‹œ ë¡œë“œ
            } else {
              log('âš ï¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨');
              showStatus('ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤', 'error');
            }
          })
          .withFailureHandler(error => {
            log(`âŒ í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™” ì˜¤ë¥˜: ${error.message || error}`);
            showStatus(`í”„ë¡¬í”„íŠ¸ ì´ˆê¸°í™” ì˜¤ë¥˜: ${error.message || error}`, 'error');
          })
          .resetSystemPromptToDefault();
      }
      
      // í˜ì´ì§€ ë¡œë“œ ì‹œ ê³¼ëª© ëª©ë¡ ì´ˆê¸°í™”
      window.onload = function() {
        log("ğŸ“š ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”ë¨");
        
        google.script.run
          .withSuccessHandler(courses => {
            const select = document.getElementById('courseSelect');
            
            if (!courses || courses.length === 0) {
              select.innerHTML = '<option value="">ê³¼ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ</option>';
              log("âš ï¸ ì‚¬ìš© ê°€ëŠ¥í•œ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤");
              return;
            }
            
            courses.forEach(course => {
              const option = document.createElement('option');
              option.value = course.id;
              option.textContent = course.name;
              select.appendChild(option);
            });
            
            log(`âœ… ${courses.length}ê°œ ê³¼ëª© ë¡œë“œ ì™„ë£Œ`);
            loadCourseWork();
          })
          .withFailureHandler(error => {
            log(`âŒ ê³¼ëª© ë¡œë“œ ì˜¤ë¥˜: ${error.message || error}`);
            showStatus(`ê³¼ëª© ë¡œë“œ ì˜¤ë¥˜: ${error.message || error}`, 'error');
          })
          .getCourses();
      };
    </script>
  </body>
</html>